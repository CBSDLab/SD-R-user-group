---
title: "Replicating CCFP Study 1 on CWRU HPC"
author: "Peter S. Hovmand"
date: "Feb 23, 2022"
output:
  pdf_document: 
    keep_tex: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This document was written and generated as an R Markdown document and exported to Word. The document includes all the code and results for replicating the results in the paper. This version is set to be run on the CWRU HPC. 

## Requirements

The following are required for replicating this simulation study:

1. Stella Architect (2.1.1 or higher) or Stella Simulator (2.1.1 or higher)
2. R (available at https://cran.r-project.org/)
3. RStudio (available at https://www.rstudio.com/)
4. Developmental-Transitions-2-2-9.stmx model

```{r load required R packages, echo=TRUE, message=TRUE, warning=FALSE}
require(readr)    # package for reading in csv files as tibble data frame
require(readxl)   # reads Excel worksheets
require(dplyr)    # for manipulating data frames, etc. 
require(ggplot2)  # for creating interactive plots 
require(reshape2) # needed to reshape data for plotting with ggplot2
```

Additionally the path for Stella Simulator needs to be set:

```{r Set path to Stella Simulator}
stella_path <- "/home/psh39/Stella_Simulator/stella_simulator"
```

## Setting up individual cases

The individual cases were generated by interactively varying the parameters and initial conditions to generate a representative set of developmental trajectories for cognitive vulnerabilities and family support. The values for initial conditions and parameters for each case were then exported from Stella Architect into an Excel worksheet that can be read by R. Having the values in an external file provides a flexible approach to add/modify cases as the model develops and replicate the analyses. 

```{r read the values for each individual case}
# read in the Excel file
cases.df <- read_excel("Cases.xlsx")

# print values of parameters and initial conditions used for each case
cases.df

# create a vector that can be used later to iterate through the cases for 
# simulation, plotting, etc
cases.vec<-1:nrow(cases.df) 
```

## Simulate a baserun for each case

The baserun for each case is simulated with the results imported via a .csv file and saved in the dataframe results.baserun. 

```{r Simulate a baserun for all the cases, message=FALSE, warning=FALSE}
results.baseruns <- NULL # create an empty objects to store results

# iterate over the list of cases 
for (i in cases.vec) {
  # print progress
  cat("Case =",i,"\n")
  
  # pull the parameters from the row in the case data frame
  parms <- cases.df %>%            # start wtih the data frame
            filter(Case==i) %>%    # select row for case = i 
            select(!Case)          # drop the Case column
  
  # write the parameters to the Stella import file
  write.csv(parms, "Parms.csv")
  
  # run the simulation 
  system2(stella_path,
        args=paste0(" ","Developmental-Transitions-2-2-10.stmx"," -r"), 
        stdout = TRUE, wait=TRUE)
  
  # read the results and add them to the data frame
  results.baseruns<-rbind(results.baseruns, 
                          tibble(Case=i,read_csv("Results.csv")))
  
}

```

## Plot results

Results are plotted using `ggplot2` package showing the dynamics of cognitive vulnerabilities and family support for each hypothetical case. 

```{r plot each case using ggplot2}
results.baseruns %>% 
  select(Case, Years, `Cognitive Vulnerabilities`, `Family Support`) %>%
  melt(id=c("Case","Years")) %>% 
    ggplot(aes(x=Years, y=value, color=variable)) +
    geom_line() +
    facet_wrap(~Case) + 
    ylab("") + 
    xlab("Age") + 
    theme(legend.position = "bottom")
```

Loop scores for each of the three major loops are then plotted for each case. 

```{r plot loop scores}
results.baseruns %>% 
  select(Case, Years, `R1 Loop Score`, `B1 Loop Score`, `B2 Loop Score`) %>%
  melt(id=c("Case","Years")) %>% 
    ggplot(aes(x=Years, y=value, color=variable)) +
    geom_line() +
    facet_wrap(~Case) + 
    ylab("Normalized Loop Score") + 
    xlab("Age") + 
    theme(legend.position = "bottom")
```

